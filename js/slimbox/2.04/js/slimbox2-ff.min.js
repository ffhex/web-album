(function($){var g=$(window),options,images,activeImage=-1,activeURL,prevImage,nextImage,compatibleOverlay,middle,centerWidth,centerHeight,ie6=!window.XMLHttpRequest,hiddenElements=[],documentElement=document.documentElement,preload={},preloadPrev=new Image(),preloadNext=new Image(),overlay,center,image,sizer,prevLink,nextLink,bottomContainer,bottom,caption,number;$(function(){$("body").append($([overlay=$('<div id="lbOverlay" />').click(close)[0],center=$('<div id="lbCenter" />')[0],bottomContainer=$('<div id="lbBottomContainer" />')[0]]).css("display","none"));image=$('<div id="lbImage" />').appendTo(center).append(sizer=$('<div style="position: relative;" />').append([prevLink=$('<a id="lbPrevLink" href="#" />').click(previous)[0],nextLink=$('<a id="lbNextLink" href="#" />').click(next)[0]])[0])[0];bottom=$('<div id="lbBottom" />').appendTo(bottomContainer).append([$('<a id="lbCloseLink" href="#" />').click(close)[0],caption=$('<div id="lbCaption" />')[0],number=$('<div id="lbNumber" />')[0],$('<div style="clear: both;" />')[0]])[0]});$.slimbox=function(a,b,c){options=$.extend({loop:false,overlayOpacity:0.8,overlayFadeDuration:400,resizeDuration:400,resizeEasing:"swing",initialWidth:250,initialHeight:250,imageFadeDuration:400,captionAnimationDuration:400,counterText:"Image {x} of {y}",closeKeys:[27,88,67],previousKeys:[37,80],nextKeys:[39,78]},c);if(typeof a=="string"){a=[[a,b]];b=0}middle=g.scrollTop()+(g.height()/2);centerWidth=options.initialWidth;centerHeight=options.initialHeight;$(center).css({top:Math.max(0,middle-(centerHeight/2)),width:centerWidth,height:centerHeight,marginLeft:-centerWidth/2}).show();compabileOverly=true;if(compatibleOverlay)overlay.style.position="absolute";$(overlay).css("opacity",options.overlayOpacity).fadeIn(options.overlayFadeDuration);position();setup(1);images=a;options.loop=options.loop&&(images.length>1);return changeImage(b)};$.fn.slimbox=function(c,d,e){d=d||function(a){return[a.href,a.title]};e=e||function(){return true};var f=this;return f.unbind("click").click(function(){var b=this,startIndex=0,filteredLinks,i=0,length;filteredLinks=$.grep(f,function(a,i){return e.call(b,a,i)});for(length=filteredLinks.length;i<length;++i){if(filteredLinks[i]==b)startIndex=i;filteredLinks[i]=d(filteredLinks[i],i)}return $.slimbox(filteredLinks,startIndex,c)})};function position(){var l=g.scrollLeft(),w=g.width();$([center,bottomContainer]).css("left",l+(w/2));center.style.top=g.scrollTop()+20}function setup(c){if(c){$("object").add(ie6?"select":"embed").each(function(a,b){hiddenElements[a]=[b,b.style.visibility];b.style.visibility="hidden"})}else{$.each(hiddenElements,function(a,b){b[0].style.visibility=b[1]});hiddenElements=[]}var d=c?"bind":"unbind";g[d]("scroll resize",position);$(document)[d]("keydown",keyDown);position()}function keyDown(a){var b=a.which,fn=$.inArray;return(fn(b,options.closeKeys)>=0)?close():(fn(b,options.nextKeys)>=0)?next():(fn(b,options.previousKeys)>=0)?previous():null}function previous(){return changeImage(prevImage)}function next(){return changeImage(nextImage)}function changeImage(a){if(a>=0){activeImage=a;activeURL=images[activeImage][0];prevImage=(activeImage||(options.loop?images.length:0))-1;nextImage=((activeImage+1)%images.length)||(options.loop?0:-1);stop();center.className="lbLoading";preload=new Image();preload.onload=animateBox;preload.src=activeURL}return false}function animateBox(){center.className="";$(image).css({backgroundImage:"url("+activeURL+")",visibility:"hidden",display:""});$(sizer).width(preload.width);$([sizer,prevLink,nextLink]).height(preload.height);$(caption).html(images[activeImage][1]||"");$(number).html((((images.length>1)&&options.counterText)||"").replace(/{x}/,activeImage+1).replace(/{y}/,images.length));if(prevImage>=0)preloadPrev.src=images[prevImage][0];if(nextImage>=0)preloadNext.src=images[nextImage][0];centerWidth=image.offsetWidth;centerHeight=image.offsetHeight;var a=Math.max(0,middle-(centerHeight/2));if(center.offsetHeight!=centerHeight){$(center).animate({height:centerHeight,top:a},options.resizeDuration,options.resizeEasing)}if(center.offsetWidth!=centerWidth){$(center).animate({width:centerWidth,marginLeft:-centerWidth/2},options.resizeDuration,options.resizeEasing)}$(center).queue(function(){$(bottomContainer).css({width:centerWidth,top:a+centerHeight,marginLeft:-centerWidth/2,visibility:"hidden",display:""});$(image).css({display:"none",visibility:"",opacity:""}).fadeIn(options.imageFadeDuration,animateCaption);center.style.top=g.scrollTop()+20})}function animateCaption(){if(prevImage>=0)$(prevLink).show();if(nextImage>=0)$(nextLink).show();$(bottom).css("marginTop",-bottom.offsetHeight).animate({marginTop:0},options.captionAnimationDuration);bottomContainer.style.visibility=""}function stop(){preload.onload=null;preload.src=preloadPrev.src=preloadNext.src=activeURL;$([center,image,bottom]).stop(true);$([prevLink,nextLink,image,bottomContainer]).hide()}function close(){if(activeImage>=0){stop();activeImage=prevImage=nextImage=-1;$(center).hide();$(overlay).stop().fadeOut(options.overlayFadeDuration,setup)}return false}})(jQuery);
